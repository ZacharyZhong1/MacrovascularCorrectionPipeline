# Macrovascular Correction Pipeline
MRA-Informed Biophysical Simulation for Removing Macrovascular Effects from fMRI

This pipeline was developed for the following studies. Please read these papers—especially the first one—carefully before using the pipeline.
>1. Zhong, X.Z., Polimeni, J.R., Chen, J.J., 2024. Predicting the macrovascular contribution to resting-state fMRI functional connectivity at 3 Tesla: A model-informed approach. Imaging Neuroscience. https://doi.org/10.1162/imag_a_00315
>2. Zhong, X.Z., Van Lankveld, H., Chen, J.J., 2025. The link to steady-state oxidative metabolism and hemodynamics varies across rs-fMRI metrics: A whole-brain assessment using macrovascular correction. Imaging Neurosci. (Camb.). https://doi.org/10.1162/imag.a.1060 
>3. Zhong, X., Van Lankveld, H., Mathew, A., Chen, J.J., 2025. The link between steady-state EEG and rs-fMRI metrics in healthy young adults: the effect of macrovascular correction. bioRxiv 2025.06.06.658306. https://doi.org/10.1101/2025.06.06.658306 (accepted by Imaging Neurosci. (Camb.))
>4. to be added...

This toolbox has four subunits. Please run the following subunits in order:

## Vessel_Segmentation
This step segments the vasculature from TOF-MRA using the BrainCharter toolbox. Please cite the original study if you use this component.
>Bernier, M., Cunnane, S. C., & Whittingstall, K. (2018). The morphology of the human cerebrovascular system. Human Brain Mapping. https://doi.org/10.1002/hbm.24337

- extract_vessel.sh
	- Function: core vessel extraction function from the BrainCharter toolbox.

- MRVExtract_Coronal.m / MRVExtract_Sagittal.m
	- Function: registers MRA to T1 space and executes the main loop that calls the primary bash script. (For our dataset, both coronal and sagittal scans were used to improve vascular completeness.)
	- Input: ParticipantFolder.txt — a text file listing input file names, one per line.

- MRV_Enhance.m
	- Function: combines segmented vascular maps from coronal and sagittal MRA scans. (Automatically processes all segmented files generated by the previous script.)

## Vessel_Seperation
This step primarily involves manually removing false-positive detections from the previous segmentation. Our approach trims all “vessels” in the middle, but you may use any method you prefer. But please follow the data structure in the code.

- Separation.m
  
	-	Function: removes unwanted segmented vessels based on provided coordinates.
	-	A while-loop with 'block' has been added to prevent accidental execution. Please remove it before running the code.

## Simulation
The key component of this pipeline simulates the BOLD signal using a biophysical model. This step is computationally intensive, depending on the spatial resolution of MRA, and is recommended to run with 200–500 GB of RAM.
Please run the following code in the specified order:

- ManualAlignment_Pipeline.m
	- Function: Aligns T1 and BOLD space using brain shape and AFNI 3dAutobox. See Ref. 1 for details.
	- Note: Double-check alignment quality and manually adjust if needed.

- fBV_Pipeline.m
	- Function: Downsamples segmented and separated vessels from T1 to BOLD space to estimate fractional blood volume (fBV). See Ref. 1 for details.
	- Note: Replace the fMRI folder in the script with your own data.

- Yv_Extractor.m
	- Function: Extracts BOLD signal from the voxel with the highest fBV as a surrogate for oxygenation level (Yv) changes as input signal for simulation. See Refs. 1 & 2 for methods.
	- Note: Replace the fMRI folder in the script with your own data.
  
- Simulation_Pipeline_Yv.m
	- Function: Simulates local B0 inhomogeneity using a Fourier-based kernel approach.
	- Note: Adjust the basic parameters as needed; upsample factor (≥4) controls resolution for B0 offset calculation.
  
- R1Decay.m / R2_Decay.m / R2P_Decay.m
	- Function: Computes T1-, T2-, and T2*-related signal decays.
  
- BOLD.m
	- Function: Combines T1, T2, and T2* components to generate the final BOLD signal.

## Macrovascular_Regression
- Macrovascular_Regression_Pipeline.m

	- Function: Regresses out the macrovascular effect using simulation and Yv signals (both provided for verification, but typically only the simulation signal is needed).
	- Note: Replace the fMRI folder in the script with your own data.
	- Note 2: Our ROI is defined as the region with simulated RSFA higher than 1% of the maximum simulated RSFA based on Ref. 1, a conservative setting. You may use a lower percentage or remove the threshold as needed (but we observed limited improvement by push threshold from 1% to 0.01%).


## Features temporarily unavailable
- Simulation for arterial signal

## Questions?
Please contact 
xzhong@research.baycrest.org 
or
jchen@research.baycrest.org
